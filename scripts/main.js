let x,y,gameTime,count,saveCount,menu=document.querySelector(".menu"),table=document.querySelector(".contain__table"),startBool=!1,sec=0,flagArr=[],fastStart=!0,money=0;document.getElementById("in").addEventListener("input",(function(){document.getElementById("bombs").innerText=this.value,document.getElementById("in_text").value=this.value}));let cc=0;function showSize(){let e=Math.floor(+document.getElementById("y_width").value),t=Math.floor(+document.getElementById("x_width").value),o=+document.getElementById("y_width").getAttribute("max"),n=+document.getElementById("y_width").getAttribute("min");e>o&&(e=o),e<n&&(e=n),t>o&&(t=o),t<n&&(t=n),(!e||e.length>2)&&(e="?"),(!t||t.length>2)&&(t="?"),document.getElementById("size").innerText=`${e}-${t}`}function lastBomb(){let e=saveCount;return document.querySelectorAll(".item_bomb").forEach((function(t){(t.classList.contains("item_block")||flagArr.includes("at"+t.getAttribute("data-pos")))&&e--})),0===e&&(setItemToLocalStorage("openBombs"),victory(),!0)}function flagLogic(e){if(document.getElementById("getFlag").classList.contains("toggle")&&!e.classList.contains("open")){let t="at"+e.getAttribute("data-pos");return e.classList.contains("item_flag")&&flagArr.length>0?(e.classList.remove("item_flag"),flagArr.splice(flagArr.indexOf(t),1)):(e.classList.add("item_flag"),flagArr.push(t)),lastBomb(),!0}}function getCoinsFunc(){document.querySelectorAll(".item_zero[data-coins]").forEach((function(e){e.classList.contains("open")&&(money+=+e.getAttribute("data-coins"),setItemToLocalStorage("all-coin"),setItemToLocalStorage(fromNumToStr(+e.getAttribute("data-coins"))+"-coin"),setItemToLocalStorage("points",+e.getAttribute("data-coins")),e.removeAttribute("data-coins"),document.querySelector(`.item[data-pos="${e.getAttribute("data-pos")}"] img`).style.display="none")})),document.getElementById("coins").innerText=`$${money}`}function bombCount(e,t){let o,n=0;for(let s=e-1;s<e+2;s++)for(let a=t-1;a<t+2;a++)s===e&&a===t||(o=getItem(a,s),o&&o.classList.contains("item_bomb")&&n++);return n}function fromNumToStr(e){switch(e){case 0:return"zero";case 1:return"one";case 2:return"two";case 3:return"three";case 4:return"four";case 5:return"five";case 6:return"six";case 7:return"seven";case 8:return"eight";case 10:return"ten";case 50:return"fifty";default:return"zero"}}function classCount(e,t,o){let n,s,a=0;for(let c=e-1;c<e+2;c++)for(let l=t-1;l<t+2;l++)if(c!==e||l!==t){s=!0,n=getItem(l,c);for(let e=0;e<o.length;e++)if("!"===o[e][0]){if(!n||n.classList.contains(o[e].substr(1,o[e].length-1))){s=!1;break}}else if(!n||!n.classList.contains(o[e])){s=!1;break}s&&a++}return a}function getItem(e,t){return document.querySelector(`.item[data-pos="${e}-${t}"]`)}function openZeroOn(e,t){let o=getItem(e,t),n=getItem(e,t-1),s=getItem(e+1,t),a=getItem(e,t+1),c=getItem(e-1,t);startBool&&!o.classList.contains("open")&&setItemToLocalStorage("zero"),o.classList.add("open");for(let o=e-1;o<e+2;o++)for(let e=t-1;e<t+2;e++)elemPos=getItem(o,e),!elemPos||elemPos.classList.contains("item_bomb")||elemPos.classList.contains("item_zero")||elemPos.classList.contains("open")||(elemPos.classList.add("open"),startBool&&(cc++,setItemToLocalStorage(fromNumToStr(+elemPos.textContent))));n&&n.classList.contains("item_zero")&&!n.classList.contains("open")&&openZeroOn(e,t-1),s&&s.classList.contains("item_zero")&&!s.classList.contains("open")&&openZeroOn(e+1,t),a&&a.classList.contains("item_zero")&&!a.classList.contains("open")&&openZeroOn(e,t+1),c&&c.classList.contains("item_zero")&&!c.classList.contains("open")&&openZeroOn(e-1,t)}function openItemFunc(){if(money>=20){let e=!0;if(flagArr.length&&(e=confirm("Вы уверены что хотите воспользоваться открытием клетки? - Список выбранных и не подтвержденных клеток с бомбами (на которых флаг) удалится"),e)){let e=flagArr.length,t=[];e=document.querySelectorAll(".item_flag:not(flag_block)").length;for(let o=0;o<e;o++)document.querySelectorAll(".item_flag:not(flag_block)")[o].classList.contains("item_block")||(flagArr.pop(),t.push(document.querySelectorAll(".item_flag:not(flag_block)")[o]));t.forEach((function(e){e.classList.remove("item_flag")}))}e&&(document.getElementById("open-item").classList.toggle("toggle"),document.getElementById("open-item").classList.contains("toggle")?money-=20:money+=20,document.getElementById("coins").innerText=`$${money}`)}else document.getElementById("open-item").classList.contains("toggle")?(document.getElementById("open-item").classList.toggle("toggle"),money+=20,document.getElementById("coins").innerText=`$${money}`):alert("Нехватает очков $"+(20-money))}function gameOver(){clearInterval(gameTime),document.querySelectorAll(".item").forEach((function(e){e.classList.add("open")})),document.querySelectorAll(".item img").forEach((function(e){e.getElementsByClassName.display="none"})),document.querySelector(".contain__table-alert").classList.contains("show")||(setItemToLocalStorage("games"),setItemToLocalStorage("lose")),document.getElementById("killed").innerText="0",document.querySelector(".contain__table-alert span").innerText="Игра Окончена",document.querySelector(".contain__table-alert").classList.add("show"),document.querySelector(".header__smile").src="images/icons/bad.png"}function setItemToLocalStorage(e,t=1){let o=localStorage.getItem(e)?+localStorage.getItem(e):0;localStorage.setItem(e,o+t)}function victory(){clearInterval(gameTime),document.querySelectorAll(".item").forEach((function(e){e.classList.add("open"),e.classList.remove("item_flag")})),document.querySelector(".contain__table-alert").classList.contains("show")||(setItemToLocalStorage("games"),setItemToLocalStorage("won")),document.getElementById("killed").innerText="0",document.querySelector(".header__smile").src="images/icons/victory.png",document.querySelector(".contain__table-alert span").innerText="Победа!",document.querySelector(".contain__table-alert").classList.add("show"),document.querySelector(".contain__table-alert").classList.add("won")}document.getElementById("in_text").addEventListener("input",(function(){let e=Math.floor(parseInt(this.value)),t=+document.getElementById("in").getAttribute("max"),o=+document.getElementById("in").getAttribute("min");e<=t&&e>=o?(document.getElementById("in").value=e,document.getElementById("bombs").innerText=e):e>t?(document.getElementById("in").value=t,document.getElementById("bombs").innerText=t):e<o&&(document.getElementById("in").value=o,document.getElementById("bombs").innerText=o)})),document.getElementById("x_width").addEventListener("input",(function(){showSize()})),document.getElementById("y_width").addEventListener("input",(function(){showSize()})),localStorage.getItem("fastStart")&&("true"===localStorage.getItem("fastStart")?(document.getElementById("fastStart").setAttribute("checked","checked"),document.querySelector(".menu__fake").classList.remove("menu__fake_unchecked"),fastStart=!0):(document.getElementById("fastStart").removeAttribute("checked"),document.querySelector(".menu__fake").classList.add("menu__fake_unchecked"),fastStart=!1)),localStorage.getItem("xWidth")&&(document.getElementById("x_width").value=localStorage.getItem("xWidth")),localStorage.getItem("yWidth")&&(document.getElementById("y_width").value=localStorage.getItem("yWidth")),document.getElementById("fastStart").addEventListener("change",(function(){fastStart=this.checked,fastStart?document.querySelector(".menu__fake").classList.remove("menu__fake_unchecked"):document.querySelector(".menu__fake").classList.add("menu__fake_unchecked")})),document.getElementById("btn").addEventListener("click",(function(){if(this.classList.contains("block"))return;if(!document.getElementById("x_width").value||!document.getElementById("y_width").value)return void alert("Пожалуйста, введите размер поля");let e=document.getElementById("size").textContent.split("-");x=+e[1],y=+e[0],1.2*+document.getElementById("in").value>x*y?alert("Слишком большое количество бомб по сравнению размером поля\nДопустимое для данного размера: "+Math.floor(x*y/1.2)):x>60||x<6||y>60||y<6?alert("Размер поля не может быть меньше 6x6 и больше 60x60"):(table.style.width=22*y+2+"px",document.querySelector(".statistic__link").target="_blank",saveCount=count=+document.getElementById("in").value,this.classList.add("block"),document.querySelector(".loading-block").classList.add("active"),setTimeout((function(){for(let e=0;e<x;e++)for(let t=0;t<y;t++)table.innerHTML+=`<button class="contain__item item" data-pos="${t}-${e}" title="${t+1}-${e+1}"></button>`}),30),setTimeout((function(){let e,t=0;for(;t!==count;)e=document.querySelector(`.item[data-pos="${Math.floor(Math.random()*y)}-${Math.floor(Math.random()*x)}"]`),e&&!e.classList.contains("item_bomb")&&(e.innerHTML='<img class="item__info" src="images/icons/bomb.svg" alt="B">',e.classList.add("item_bomb"),t++);for(let t=0;t<x;t++)for(let o=0;o<y;o++)if(e=document.querySelector(`.item[data-pos="${o}-${t}"]`),!e.classList.contains("item_bomb")){let n=bombCount(t,o);if(0!==n)e.innerText=n,e.classList.add("item"+n);else{let t=3e3,o=Math.floor(Math.random()*t);e.classList.add("item_zero"),o>t-80&&(o<t-10?(e.setAttribute("data-coins","1"),e.innerHTML+='<img class="item-coin" src="images/coins/one-coin.svg" alt="1 Coin">'):o>=t-10&&o<t-3?(e.setAttribute("data-coins","5"),e.innerHTML+='<img class="item-coin" src="images/coins/five-coin.svg" alt="5 Coins">'):o>=t-3&&o<t-1?(e.setAttribute("data-coins","10"),e.innerHTML+='<img class="item-coin" src="images/coins/ten-coin.svg" alt="10 Coins">'):o===t-1&&(e.setAttribute("data-coins","50"),e.innerHTML+='<img class="item-coin" src="images/coins/fifty-coin.svg" alt="50 Coins">'))}}if(document.getElementById("open-item").addEventListener("click",(function(){openItemFunc(),setItemToLocalStorage("buttons")})),document.querySelectorAll(".item_zero").forEach((function(e){e.addEventListener("click",(function(){if(document.getElementById("getFlag").classList.contains("toggle"))return;let t=e.getAttribute("data-pos").split("-");e.classList.contains("open")||setItemToLocalStorage("empty"),openZeroOn(+t[0],+t[1])}))})),document.querySelectorAll(".item").forEach((function(e){e.addEventListener("click",(function(){if(startBool||(startBool=!0,gameTime=setInterval((function(){sec++;let e=Math.floor(sec/3600)+"",t=Math.floor(sec/60)%60+"",o=sec%60+"";for(;e.length<3;)e="0"+e;for(;t.length<2;)t="0"+t;for(;o.length<2;)o="0"+o;setItemToLocalStorage("seconds"),document.getElementById("time").innerText=`${e}:${t}:${o}`}),1e3)),setItemToLocalStorage("clicks"),document.getElementById("open-item").classList.contains("toggle")&&!e.classList.contains("open"))return document.getElementById("open-item").classList.remove("toggle"),void(e.classList.contains("item_bomb")?(e.classList.add("item_block"),e.classList.add("item_flag"),count--,money++,setItemToLocalStorage("openBombs"),setItemToLocalStorage("points"),0===count&&victory(),document.getElementById("killed").innerText=`${count}`,document.getElementById("coins").innerText=`$${money}`):(e.classList.contains("open")||(cc++,setItemToLocalStorage(fromNumToStr(+e.textContent))),e.classList.add("open")));if(!(flagLogic(e)||e.classList.contains("item_block")||e.classList.contains("item_flag"))){if(e.classList.contains("item_zero")&&e.getAttribute("data-coins")&&e.classList.contains("open")&&(setItemToLocalStorage("all-coin"),setItemToLocalStorage("coins"),setItemToLocalStorage(fromNumToStr(+e.getAttribute("data-coins"))+"-coin"),setItemToLocalStorage("points",+e.getAttribute("data-coins")),money+=+e.getAttribute("data-coins"),e.removeAttribute("data-coins"),document.querySelector(`.item[data-pos="${e.getAttribute("data-pos")}"] img`).style.display="none",document.getElementById("coins").innerText=`$${money}`),flagArr.length>0&&!e.classList.contains("item_open")&&!document.getElementById("getFlag").classList.contains("toggle")){let e=!0;flagArr.forEach((function(t){let o=t.substr(2,t.length-1),n=document.querySelector(`.item[data-pos="${o}"`);n&&n.classList.contains("item_bomb")?(count--,money++,n.classList.add("item_block"),setItemToLocalStorage("openBombs"),setItemToLocalStorage("points"),setItemToLocalStorage("flagBomb"),0===count&&victory()):e&&(e=!1,gameOver())}));let t=flagArr.length;for(let e=0;e<t;e++)flagArr.pop();document.getElementById("killed").innerText=count,document.getElementById("coins").innerText=`$${money}`}e.classList.contains("item_bomb")?(gameOver(),setItemToLocalStorage("boom")):(e.classList.contains("open")||(cc++,setItemToLocalStorage(fromNumToStr(+e.textContent)),+e.textContent&&setItemToLocalStorage("numbers")),e.classList.add("open"))}})),e.addEventListener("dblclick",(function(){if(e.classList.contains("open")&&!e.classList.contains("item_zero")){setItemToLocalStorage("dblclick"),setItemToLocalStorage("clicks",-1);let t=e.getAttribute("data-pos").split("-");t[0]=+t[0],t[1]=+t[1];let o=classCount(t[1],t[0],["item_bomb","item_block"]),n=classCount(t[1],t[0],["item_bomb"]),s=classCount(t[1],t[0],["!item_bomb","open"]);if(classCount(t[1],t[0],["item"])-s===n)for(let e=t[0]-1;e<t[0]+2;e++)for(let o=t[1]-1;o<t[1]+2;o++){let t=getItem(e,o);t&&t.classList.contains("item_bomb")&&!t.classList.contains("item_block")&&(t.classList.add("item_block"),t.classList.add("item_flag"),count--,0===count&&victory(),money++,setItemToLocalStorage("openBombs"),setItemToLocalStorage("points"),document.getElementById("killed").innerText=count,document.getElementById("coins").innerText=`$${money}`)}if(o===+e.textContent)for(let e=t[1]-1;e<t[1]+2;e++)for(let o=t[0]-1;o<t[0]+2;o++){let t=getItem(o,e);if(t&&t.classList.contains("item_zero")&&!t.classList.contains("open")){let e=t.getAttribute("data-pos").split("-");openZeroOn(+e[0],+e[1])}!t||t.classList.contains("item_bomb")||t.classList.contains("open")||(cc++,setItemToLocalStorage(fromNumToStr(+t.textContent)),t.classList.add("open"))}}}))})),fastStart){let e,t=document.querySelectorAll(".item_zero");if(t.length>0){e=t[Math.floor(Math.random()*t.length)];let o=e.getAttribute("data-pos").split("-");openZeroOn(+o[0],+o[1]),e.classList.add("open")}else alert("Ошибка существования пустой ячейки. Пожалуйста, порезагрузите страницу")}document.body.classList.remove("lock"),document.querySelector(".loading-block").classList.remove("active"),menu.classList.add("delete")}),250),document.getElementById("killed").innerText=count)})),document.getElementById("getFlag").addEventListener("click",(function(){setItemToLocalStorage("buttons"),this.classList.toggle("toggle")})),document.getElementById("get-coins").addEventListener("click",(function(){setItemToLocalStorage("buttons"),getCoinsFunc()})),document.getElementById("reload").addEventListener("click",(function(){setItemToLocalStorage("buttons"),confirm("Вы уверены, что хотите перезагрузить страницу? Прохождение этой игры будет утеряно.")&&window.location.reload(!1)}));let ctrlKeyPressed=!1;document.addEventListener("keydown",(function(e){e.ctrlKey&&(document.getElementById("getFlag").classList.add("toggle"),ctrlKeyPressed=!0),document.querySelector(".contain__table").style.width||"Enter"!==e.key||document.getElementById("btn").click(),"Tab"==e.key&&""!==document.getElementById("killed").innerText&&(setItemToLocalStorage("combinations"),openItemFunc()),e.ctrlKey&&"Enter"===e.key&&(setItemToLocalStorage("combinations"),getCoinsFunc())})),document.addEventListener("keyup",(function(){ctrlKeyPressed&&(document.getElementById("getFlag").classList.remove("toggle"),ctrlKeyPressed=!1)})),document.querySelectorAll(".footer__link").forEach((function(e){e.target="_blank"}));let bombs=40;null!==localStorage.getItem("bombs")&&(bombs=+localStorage.getItem("bombs")),document.getElementById("in").value=bombs,document.getElementById("in_text").value=bombs,document.getElementById("bombs").innerText=bombs,document.getElementById("size").innerText=`${document.getElementById("y_width").value}-${document.getElementById("x_width").value}`,window.addEventListener("unload",(function(){let e=document.getElementById("size").innerText.split("-");localStorage.setItem("bombs",document.getElementById("in").value),localStorage.setItem("fastStart",fastStart),localStorage.setItem("xWidth",e[1]),localStorage.setItem("yWidth",e[0])}));