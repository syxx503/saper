let x,y,gameTime,count,saveCount,menu=document.querySelector(".menu"),table=document.querySelector(".contain__table"),startBool=!1,sec=0,flagArr=[],fastStart=!0,money=0;function showSize(){let e=Math.floor(+document.getElementById("y_width").value),t=Math.floor(+document.getElementById("x_width").value),n=+document.getElementById("y_width").getAttribute("max"),o=+document.getElementById("y_width").getAttribute("min");e>n&&(e=n),e<o&&(e=o),t>n&&(t=n),t<o&&(t=o),(!e||e.length>2)&&(e="?"),(!t||t.length>2)&&(t="?"),document.getElementById("size").innerText=`${e}-${t}`}function lastBomb(){let e=saveCount;return document.querySelectorAll(".item_bomb").forEach((function(t){(t.classList.contains("item_block")||flagArr.includes("at"+t.getAttribute("data-pos")))&&e--})),0===e&&(victory(),!0)}function flagLogic(e){if(document.getElementById("getFlag").classList.contains("toggle")&&!e.classList.contains("open")){let t="at"+e.getAttribute("data-pos");return e.classList.contains("item_flag")&&flagArr.length>0?(e.classList.remove("item_flag"),flagArr.splice(flagArr.indexOf(t),1)):(e.classList.add("item_flag"),flagArr.push(t)),lastBomb(),!0}}function getCoinsFunc(){document.querySelectorAll(".item_zero[data-coins]").forEach((function(e){e.classList.contains("open")&&(money+=+e.getAttribute("data-coins"),e.removeAttribute("data-coins"),document.querySelector(`.item[data-pos="${e.getAttribute("data-pos")}"] img`).style.display="none")})),document.getElementById("coins").innerText=`$${money}`}function bombCount(e,t){let n,o=0;for(let l=e-1;l<e+2;l++)for(let s=t-1;s<t+2;s++)l===e&&s===t||(n=getItem(s,l),n&&n.classList.contains("item_bomb")&&o++);return o}function classCount(e,t,n){let o,l,s=0;for(let i=e-1;i<e+2;i++)for(let c=t-1;c<t+2;c++)if(i!==e||c!==t){l=!0,o=getItem(c,i);for(let e=0;e<n.length;e++)if("!"===n[e][0]){if(!o||o.classList.contains(n[e].substr(1,n[e].length-1))){l=!1;break}}else if(!o||!o.classList.contains(n[e])){l=!1;break}l&&s++}return s}function getItem(e,t){return document.querySelector(`.item[data-pos="${e}-${t}"]`)}function openZeroOn(e,t){let n=getItem(e,t-1),o=getItem(e+1,t),l=getItem(e,t+1),s=getItem(e-1,t);getItem(e,t).classList.add("open");for(let n=e-1;n<e+2;n++)for(let e=t-1;e<t+2;e++)elemPos=getItem(n,e),!elemPos||elemPos.classList.contains("item_bomb")||elemPos.classList.contains("item_zero")||elemPos.classList.add("open");n&&n.classList.contains("item_zero")&&!n.classList.contains("open")&&openZeroOn(e,t-1),o&&o.classList.contains("item_zero")&&!o.classList.contains("open")&&openZeroOn(e+1,t),l&&l.classList.contains("item_zero")&&!l.classList.contains("open")&&openZeroOn(e,t+1),s&&s.classList.contains("item_zero")&&!s.classList.contains("open")&&openZeroOn(e-1,t)}function openItemFunc(){if(money>=20){let e=!0;if(flagArr.length&&(e=confirm("Вы уверены что хотите воспользоваться открытием клетки? - Список выбранных и не подтвержденных клеток с бомбами (на которых флаг) удалится"),e)){let e=flagArr.length,t=[];e=document.querySelectorAll(".item_flag:not(flag_block)").length;for(let n=0;n<e;n++)document.querySelectorAll(".item_flag:not(flag_block)")[n].classList.contains("item_block")||(flagArr.pop(),t.push(document.querySelectorAll(".item_flag:not(flag_block)")[n]));t.forEach((function(e){e.classList.remove("item_flag")}))}e&&(document.getElementById("open-item").classList.toggle("toggle"),document.getElementById("open-item").classList.contains("toggle")?money-=20:money+=20,document.getElementById("coins").innerText=`$${money}`)}else document.getElementById("open-item").classList.contains("toggle")?(document.getElementById("open-item").classList.toggle("toggle"),money+=20,document.getElementById("coins").innerText=`$${money}`):alert("Нехватает очков $"+(20-money))}function gameOver(){clearInterval(gameTime),document.querySelectorAll(".item").forEach((function(e){e.classList.add("open")})),document.querySelectorAll(".item img").forEach((function(e){e.getElementsByClassName.display="none"})),document.getElementById("killed").innerText="0",document.querySelector(".contain__table-alert span").innerText="Игра Окончена",document.querySelector(".contain__table-alert").classList.add("show"),document.querySelector(".header__smile").src="images/icons/bad.png"}function victory(){clearInterval(gameTime),document.querySelectorAll(".item").forEach((function(e){e.classList.add("open"),e.classList.remove("item_flag")})),document.querySelectorAll(".item img").forEach((function(e){e.getElementsByClassName.display="none"})),document.getElementById("killed").innerText="0",document.querySelector(".header__smile").src="images/icons/victory.png",document.querySelector(".contain__table-alert span").innerText="Победа!",document.querySelector(".contain__table-alert").classList.add("show"),document.querySelector(".contain__table-alert").classList.add("won")}document.getElementById("in").addEventListener("input",(function(){document.getElementById("bombs").innerText=this.value,document.getElementById("in_text").value=this.value})),document.getElementById("in_text").addEventListener("input",(function(){let e=Math.floor(parseInt(this.value)),t=+document.getElementById("in").getAttribute("max"),n=+document.getElementById("in").getAttribute("min");e<=t&&e>=n?(document.getElementById("in").value=e,document.getElementById("bombs").innerText=e):e>t?(document.getElementById("in").value=t,document.getElementById("bombs").innerText=t):e<n&&(document.getElementById("in").value=n,document.getElementById("bombs").innerText=n)})),document.getElementById("x_width").addEventListener("input",(function(){showSize()})),document.getElementById("y_width").addEventListener("input",(function(){showSize()})),localStorage.getItem("fastStart")&&("true"===localStorage.getItem("fastStart")?(document.getElementById("fastStart").setAttribute("checked","checked"),document.querySelector(".menu__fake").classList.remove("menu__fake_unchecked"),fastStart=!0):(document.getElementById("fastStart").removeAttribute("checked"),document.querySelector(".menu__fake").classList.add("menu__fake_unchecked"),fastStart=!1)),localStorage.getItem("xWidth")&&(document.getElementById("x_width").value=localStorage.getItem("xWidth")),localStorage.getItem("yWidth")&&(document.getElementById("y_width").value=localStorage.getItem("yWidth")),document.getElementById("fastStart").addEventListener("change",(function(){fastStart=this.checked,fastStart?document.querySelector(".menu__fake").classList.remove("menu__fake_unchecked"):document.querySelector(".menu__fake").classList.add("menu__fake_unchecked")})),document.getElementById("btn").addEventListener("click",(function(){this.classList.contains("block")||(document.getElementById("x_width").value&&document.getElementById("y_width").value?(x=Math.floor(+document.getElementById("x_width").value),y=Math.floor(+document.getElementById("y_width").value),+document.getElementById("in").value+4>x*y?alert("Слишком большое количество бомб по сравнению размером поля"):x>65||x<6||y>65||y<6?alert("Размер поля не может быть меньше 6x6 и больше 65x65"):(table.style.width=22*y+2+"px",saveCount=count=+document.getElementById("in").value,this.classList.add("block"),document.querySelector(".loading-block").classList.add("active"),setTimeout((function(){for(let e=0;e<x;e++)for(let t=0;t<y;t++)table.innerHTML+=`<button class="contain__item item" data-pos="${t}-${e}" title="${t+1}-${e+1}"></button>`}),30),setTimeout((function(){let e,t=0;for(;t!==count;)e=document.querySelector(`.item[data-pos="${Math.floor(Math.random()*y)}-${Math.floor(Math.random()*x)}"]`),e&&!e.classList.contains("item_bomb")&&(e.innerHTML='<img class="item__info" src="images/icons/bomb.svg" alt="B">',e.classList.add("item_bomb"),t++);for(let t=0;t<x;t++)for(let n=0;n<y;n++)if(e=document.querySelector(`.item[data-pos="${n}-${t}"]`),!e.classList.contains("item_bomb")){let o=bombCount(t,n);if(0!==o)e.innerText=o,e.classList.add("item"+o);else{let t=3e3,n=Math.floor(Math.random()*t);e.classList.add("item_zero"),n>t-80&&(n<t-10?(e.setAttribute("data-coins","1"),e.innerHTML+='<img class="item-coin" src="images/coins/one-coin.svg" alt="1 Coin">'):n>=t-10&&n<t-3?(e.setAttribute("data-coins","5"),e.innerHTML+='<img class="item-coin" src="images/coins/five-coin.svg" alt="5 Coins">'):n>=t-3&&n<t-1?(e.setAttribute("data-coins","10"),e.innerHTML+='<img class="item-coin" src="images/coins/ten-coin.svg" alt="10 Coins">'):n===t-1&&(e.setAttribute("data-coins","50"),e.innerHTML+='<img class="item-coin" src="images/coins/fifty-coin.svg" alt="50 Coins">'))}}if(document.getElementById("open-item").addEventListener("click",(function(){openItemFunc()})),document.querySelectorAll(".item").forEach((function(e){e.addEventListener("click",(function(){if(startBool||(startBool=!0,gameTime=setInterval((function(){sec++;let e=Math.floor(sec/3600)+"",t=Math.floor(sec/60)%60+"",n=sec%60+"";for(;e.length<3;)e="0"+e;for(;t.length<2;)t="0"+t;for(;n.length<2;)n="0"+n;document.getElementById("time").innerText=`${e}:${t}:${n}`}),1e3)),document.getElementById("open-item").classList.contains("toggle")&&!e.classList.contains("open")&&(document.getElementById("open-item").classList.remove("toggle"),e.classList.contains("item_bomb")?(e.classList.add("item_block"),e.classList.add("item_flag"),count--,money++,0===count&&victory(),document.getElementById("killed").innerText=`${count}`,document.getElementById("coins").innerText=`$${money}`):e.classList.add("open")),!(flagLogic(e)||e.classList.contains("item_block")||e.classList.contains("item_flag"))){if(e.classList.contains("item_zero")&&e.getAttribute("data-coins")&&(money+=+e.getAttribute("data-coins"),e.removeAttribute("data-coins"),document.querySelector(`.item[data-pos="${e.getAttribute("data-pos")}"] img`).style.display="none",document.getElementById("coins").innerText=`$${money}`),flagArr.length>0&&!e.classList.contains("item_open")&&!document.getElementById("getFlag").classList.contains("toggle")){flagArr.forEach((function(e){let t=e.substr(2,e.length-1),n=document.querySelector(`.item[data-pos="${t}"`);n&&n.classList.contains("item_bomb")?(count--,money++,document.getElementById("killed").innerText=count,document.getElementById("coins").innerText=`$${money}`,n.classList.add("item_block"),0===count&&victory()):gameOver()}));let e=flagArr.length;for(let t=0;t<e;t++)flagArr.pop()}e.classList.add("open"),e.classList.contains("item_bomb")&&gameOver()}})),e.addEventListener("dblclick",(function(){if(e.classList.contains("open")&&!e.classList.contains("item_zero")){let t=e.getAttribute("data-pos").split("-");t[0]=+t[0],t[1]=+t[1];let n=classCount(t[1],t[0],["item_bomb","item_block"]),o=classCount(t[1],t[0],["item_bomb"]),l=classCount(t[1],t[0],["!item_bomb","open"]);if(classCount(t[1],t[0],["item"])-l===o)for(let e=t[0]-1;e<t[0]+2;e++)for(let n=t[1]-1;n<t[1]+2;n++){let t=getItem(e,n);t&&t.classList.contains("item_bomb")&&!t.classList.contains("item_block")&&(t.classList.add("item_block"),t.classList.add("item_flag"),count--,0===count&&victory(),money++,document.getElementById("killed").innerText=count,document.getElementById("coins").innerText=`$${money}`)}if(n===+e.textContent)for(let e=t[1]-1;e<t[1]+2;e++)for(let n=t[0]-1;n<t[0]+2;n++){let t=getItem(n,e);if(t&&t.classList.contains("item_zero")&&!t.classList.contains("open")){let e=t.getAttribute("data-pos").split("-");openZeroOn(+e[0],+e[1])}t&&!t.classList.contains("item_bomb")&&t.classList.add("open")}}}))})),fastStart){let e,t=document.querySelectorAll(".item_zero");if(t.length>0){e=t[Math.floor(Math.random()*t.length)],e.classList.add("open");let n=e.getAttribute("data-pos").split("-");openZeroOn(+n[0],+n[1])}else alert("Ошибка существования пустой ячейки. Пожалуйста, порезагрузите страницу")}document.querySelectorAll(".item_zero").forEach((function(e){e.addEventListener("click",(function(){if(document.getElementById("getFlag").classList.contains("toggle"))return;let t=e.getAttribute("data-pos").split("-");openZeroOn(+t[0],+t[1])}))})),document.body.classList.remove("lock"),document.querySelector(".loading-block").classList.remove("active"),menu.classList.add("delete")}),250),document.getElementById("killed").innerText=count)):alert("Пожалуйста, введите размер поля"))})),document.getElementById("getFlag").addEventListener("click",(function(){this.classList.toggle("toggle")})),document.getElementById("get-coins").addEventListener("click",getCoinsFunc),document.getElementById("reload").addEventListener("click",(function(){confirm("Вы уверены, что хотите перезагрузить страницу? Прохождение этой игры будет утеряно.")&&window.location.reload(!1)}));let ctrlKeyPressed=!1;document.addEventListener("keydown",(function(e){e.ctrlKey&&(document.getElementById("getFlag").classList.add("toggle"),ctrlKeyPressed=!0),"Tab"==e.key&&""!==document.getElementById("killed").innerText&&openItemFunc(),e.ctrlKey&&"Enter"===e.key&&getCoinsFunc()})),document.addEventListener("keyup",(function(){ctrlKeyPressed&&(document.getElementById("getFlag").classList.remove("toggle"),ctrlKeyPressed=!1)})),document.querySelectorAll(".footer__link").forEach((function(e){e.target="_blank"}));let bombs=40;null!==localStorage.getItem("bombs")&&(bombs=+localStorage.getItem("bombs")),document.getElementById("in").value=bombs,document.getElementById("in_text").value=bombs,document.getElementById("bombs").innerText=bombs,document.getElementById("size").innerText=`${document.getElementById("y_width").value}-${document.getElementById("x_width").value}`,window.addEventListener("unload",(function(){let e=document.getElementById("size").innerText.split("-");localStorage.setItem("bombs",document.getElementById("in").value),localStorage.setItem("fastStart",fastStart),localStorage.setItem("xWidth",e[1]),localStorage.setItem("yWidth",e[0])}));